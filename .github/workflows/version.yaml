---
name: Versioning

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  calculateVersion:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      current: ${{ steps.version.outputs.current }}
      skip: ${{ steps.version.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: freerangebytes/setup-svu@v0.2.0

      - name: Calculate next version
        id: version
        run: |
          CURRENT=$(svu current || echo "v0.0.0")
          NEXT=$(svu next)

          echo "Current: $CURRENT"
          echo "Next: $NEXT"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

          if [ "$CURRENT" = "$NEXT" ]; then
            echo "No version bump needed"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "version=$NEXT" >> "$GITHUB_OUTPUT"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  tag:
    name: Create Tag and Release
    runs-on: ubuntu-latest
    needs: calculateVersion
    if: needs.calculateVersion.outputs.skip != 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create Tag and Release
        id: release
        uses: freerangebytes/create-release@v0.2.0
        with:
          version: ${{ needs.calculateVersion.outputs.version }}
          previous-version: ${{ needs.calculateVersion.outputs.current }}
